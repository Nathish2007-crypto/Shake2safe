<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shake2Save</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS for styling the app */
        :root {
            --primary-color: #c70000;
            --background-color: #f0f2f5;
            --text-color: #333;
            --light-text-color: #666;
            --header-bg: #ffffff;
            --button-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- NEW: Onboarding Screens --- */
        .onboarding-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color); z-index: 6000;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        .onboarding-header {
            background-color: var(--header-bg); padding: 15px; text-align: center;
            font-size: 1.2em; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .onboarding-form {
            padding: 20px; display: flex; flex-direction: column; gap: 15px; flex-grow: 1;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: var(--light-text-color); }
        .form-group input {
            padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em;
            font-family: 'Poppins', sans-serif;
        }
        .onboarding-form button {
            margin-top: auto; /* Pushes button to the bottom */
            padding: 15px; font-size: 1.1em; font-weight: 600;
            color: white; background-color: var(--primary-color); border: none;
            border-radius: 8px; cursor: pointer; transition: background-color 0.2s;
        }
        .contact-group {
            background-color: #fff; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; text-align: left;
        }
        .contact-group h3 {
            margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee;
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .contact-group h3 span { font-weight: 500; font-size: 0.9em; color: var(--light-text-color); }
        
        /* --- YOUR EXISTING APP CSS --- */
        .header { background-color: var(--header-bg); padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-title { font-weight: 600; font-size: 1.1em; color: var(--text-color); }
        .header-icon { font-size: 1.5em; cursor: pointer; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; background: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(229,229,229,1) 100%); }
        .title { font-size: 2em; font-weight: 700; color: #5d2b2b; margin-bottom: 5px; }
        .subtitle { font-size: 1.2em; color: var(--primary-color); margin-bottom: 30px; }
        .sos-button-container { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        .sos-button { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, #ff4b4b, var(--primary-color)); border: 8px solid #fff; box-shadow: var(--button-shadow), inset 0 0 15px rgba(255,255,255,0.4); color: white; font-size: 2.5em; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s; z-index: 1; }
        .pulsing-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 10px solid rgba(200, 0, 0, 0.3); animation: pulse 2s infinite; z-index: 0; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        /* ... All of your other 700+ lines of CSS go here ... */
    </style>
</head>
<body>

    <!-- Onboarding: Registration Screen -->
    <div id="registrationScreen" class="onboarding-screen">
        <div class="onboarding-header">CREATE YOUR PROFILE</div>
        <form id="registrationForm" class="onboarding-form">
            <div class="form-group">
                <label for="userNameInput">Name (Mandatory)</label>
                <input type="text" id="userNameInput" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label for="userPhoneInput">Your Mobile Number (Mandatory)</label>
                <input type="tel" id="userPhoneInput" placeholder="Enter 10-digit number" required pattern="[0-9]{10}">
            </div>
            <button type="submit">NEXT</button>
        </form>
    </div>

    <!-- Onboarding: Emergency Contacts Screen -->
    <div id="contactsScreen" class="onboarding-screen hidden">
        <div class="onboarding-header">EMERGENCY CONTACTS</div>
        <form id="contactsForm" class="onboarding-form">
            <div class="contact-group">
                <h3>Contact - 1 <span>(Mandatory)</span></h3>
                <input type="tel" id="contact1" placeholder="Enter 10-digit number" required pattern="[0-9]{10}">
            </div>
            <div class="contact-group">
                <h3>Contact - 2 <span>(Mandatory)</span></h3>
                <input type="tel" id="contact2" placeholder="Enter 10-digit number" required pattern="[0-9]{10}">
            </div>
            <div class="contact-group">
                <h3>Contact - 3 <span>(Optional)</span></h3>
                <input type="tel" id="contact3" placeholder="Enter 10-digit number" pattern="[0-9]{10}">
            </div>
            <button type="submit">FINISH SETUP</button>
        </form>
    </div>

    <!-- YOUR MAIN APP (Initially hidden) -->
    <div id="mainApp" class="hidden" style="display: flex; flex-direction: column; min-height: 100vh;">
        <header class="header">
             <span class="header-icon" id="hamburgerIcon">â˜°</span>
             <span class="header-title">SHAKE2SAVE - SAFETY APP</span>
             <span class="header-icon">ðŸ””</span>
        </header>
        <main class="main-content">
             <h1 class="title">SHAKE2SAVE</h1>
             <p class="subtitle">Press the Button or Shake in Emergency</p>
             <div class="sos-button-container">
                 <div class="pulsing-ring"></div>
                 <button id="sosButton" class="sos-button">SOS</button>
             </div>
             <p class="info-text">You will alert your trusted contacts.</p>
             <div class="button-group">
                 <button id="reportButton" class="report-button">Quick Report</button>
             </div>
             <div class="powered-by">
                 <p>POWERED BY</p>
                 <img src="https://placehold.co/100x100/ffffff/c70000?text=CW" alt="Code Warriors Logo">
             </div>
        </main>
        <footer class="footer">
             <p>Shake2Save | A Code Warriors Project</p>
             <button id="sirenButton" class="siren-button">Siren</button>
        </footer>
        <!-- All your modals and side nav HTML would go here -->
    </div>
    
    <!-- ============================================= -->
    <!-- ============== SCRIPT BLOCKS ================ -->
    <!-- ============================================= -->

    <!-- STEP 1: ADD FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            /* Your config object */
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Make Firestore functions globally accessible ---
        window.db = {
            saveUserData: (userId, userData) => setDoc(doc(db, "users", userId), userData, { merge: true }),
            getUserData: (userId) => getDoc(doc(db, "users", userId)),
            addReport: (reportData) => addDoc(collection(db, "reports"), reportData),
            getReports: () => getDocs(collection(db, "reports")),
            serverTimestamp: serverTimestamp
        };
    </script>
    
    <!-- STEP 2: ADD GOOGLE MAPS API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=visualization&callback=initMap" defer></script>

    <!-- STEP 3: MAIN APPLICATION JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const registrationScreen = document.getElementById('registrationScreen');
            const contactsScreen = document.getElementById('contactsScreen');
            const mainApp = document.getElementById('mainApp');
            const registrationForm = document.getElementById('registrationForm');
            const contactsForm = document.getElementById('contactsForm');

            // --- 1. Check if user is already registered ---
            let userId = localStorage.getItem('shake2save_userId');
            const isRegistered = localStorage.getItem('shake2save_isRegistered') === 'true';

            if (!userId) {
                userId = 'user_' + Date.now(); // More robust unique ID
                localStorage.setItem('shake2save_userId', userId);
            }
            
            // Wait for Firestore to be initialized
            while (!window.db) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            if (isRegistered) {
                registrationScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                // You would load user data here to populate side nav etc.
            } else {
                registrationScreen.classList.remove('hidden');
            }

            // --- 2. Handle Registration Form Submission ---
            registrationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userName = document.getElementById('userNameInput').value.trim();
                const userPhone = document.getElementById('userPhoneInput').value.trim();

                if (!userName || !userPhone || !/^\d{10}$/.test(userPhone)) {
                    alert('Please enter a valid name and 10-digit phone number.');
                    return;
                }

                try {
                    await window.db.saveUserData(userId, { name: userName, phone: userPhone });
                    registrationScreen.classList.add('hidden');
                    contactsScreen.classList.remove('hidden');
                } catch (error) {
                    console.error("Error saving user data: ", error);
                    alert("Could not save profile. Please try again.");
                }
            });

            // --- 3. Handle Contacts Form Submission ---
            contactsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const contact1 = document.getElementById('contact1').value.trim();
                const contact2 = document.getElementById('contact2').value.trim();
                const contact3 = document.getElementById('contact3').value.trim();

                if (!contact1 || !contact2 || !/^\d{10}$/.test(contact1) || !/^\d{10}$/.test(contact2)) {
                    alert('Please enter at least two valid 10-digit emergency contacts.');
                    return;
                }

                const emergencyContacts = [contact1, contact2, contact3].filter(c => c);

                try {
                    await window.db.saveUserData(userId, { emergencyContacts });
                    localStorage.setItem('shake2save_isRegistered', 'true');
                    contactsScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                } catch (error) {
                    console.error("Error saving contacts: ", error);
                    alert("Could not save contacts. Please try again.");
                }
            });

            // --- 4. Your existing main app logic (SOS button, modals, side nav, etc.) goes here ---
            // ... (The rest of your 700+ lines of JavaScript)
        });

        // Your global functions like initMap, showStatus, etc. would be here
        function initMap() {
            // Map initialization logic
        }
    </script>
</body>
</html>

